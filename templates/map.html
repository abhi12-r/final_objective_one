<!DOCTYPE html>
<html>
<head>
    <title>OSS Health Map</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />

    <style>
        body {
            margin: 0;
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            background: #f5f5f5;
        }
        .wrapper {
            max-width: 1100px;
            margin: 12px auto;
            padding: 12px;
        }
        h2 {
            margin: 0 0 4px 0;
            font-size: 20px;
            color: #1a237e;
        }
        .subtitle {
            margin: 0 0 10px 0;
            font-size: 12px;
            color: #607d8b;
        }
        #map {
            height: 520px;
            border-radius: 12px;
            border: 1px solid #cfd8dc;
            box-shadow: 0 6px 18px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        .legend {
            background: white;
            padding: 6px 8px;
            font-size: 12px;
            line-height: 18px;
            border-radius: 6px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.15);
        }
        .legend span {
            display: inline-block;
            width: 12px;
            height: 12px;
            margin-right: 4px;
            border-radius: 999px;
        }
        #density {
            margin-top: 10px;
            font-size: 13px;
            font-weight: 600;
            color: #37474f;
        }
    </style>
</head>
<body>
<div class="wrapper">
    <h2>OSS Health Map</h2>
    <p class="subtitle">
        Each point represents a septic tank / OSS in the dataset. Colours indicate health status.
    </p>
    <div id="map"></div>
    <div id="density"></div>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
    let map = L.map('map').setView([20.5937, 78.9629], 5);
    let markersLayer = L.layerGroup().addTo(map);
    let points = [];

    L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
        maxZoom: 19,
        attribution: '&copy; OpenStreetMap &copy; CARTO'
    }).addTo(map);

    function getColor(status) {
        if (status === "healthy") return "green";
        if (status === "warning") return "orange";
        return "red";
    }

    function createCircleMarker(lat, lon, status, popupText) {
        return L.circleMarker([lat, lon], {
            radius: 7,
            color: getColor(status),
            fillColor: getColor(status),
            fillOpacity: 0.85
        }).bindPopup(popupText);
    }

    function updateDensity() {
        const n = points.length;
        const densityDiv = document.getElementById("density");

        if (n < 2) {
            densityDiv.textContent = "OSS density: need at least 2 points to estimate area.";
            return;
        }

        let latMin = Infinity, latMax = -Infinity;
        let lonMin = Infinity, lonMax = -Infinity;

        points.forEach(p => {
            if (p.lat < latMin) latMin = p.lat;
            if (p.lat > latMax) latMax = p.lat;
            if (p.lon < lonMin) lonMin = p.lon;
            if (p.lon > lonMax) lonMax = p.lon;
        });

        const R = 6371000;
        const toRad = Math.PI / 180;

        const latCenter = (latMin + latMax) / 2 * toRad;
        const dLat = (latMax - latMin) * toRad;
        const dLon = (lonMax - lonMin) * toRad;

        const height = dLat * R;
        const width = dLon * R * Math.cos(latCenter);
        const area_m2 = Math.max(height * width, 1);

        const densityPerM2 = n / area_m2;
        const densityPerKm2 = densityPerM2 * 1e6;

        densityDiv.textContent =
            `Approx. OSS density (bounding box): ${densityPerKm2.toFixed(1)} points/km²  (${densityPerM2.toExponential(3)} points/m², N = ${n})`;
    }

    async function loadEntries() {
        try {
            let res = await fetch("/api/entries");
            let data = await res.json();

            markersLayer.clearLayers();
            points = [];

            data.forEach(entry => {
                if (entry.lat !== null && entry.lon !== null) {
                    points.push({ lat: entry.lat, lon: entry.lon });

                    let namePart = entry.name ? `Name: <b>${entry.name}</b><br>` : "";
                    let popup = `
                        ${namePart}
                        Status: <b>${entry.status.toUpperCase()}</b><br>
                        Next emptying: ${entry.next_emptying_date}<br>
                        N (years): ${entry.N_years}<br>
                        P: ${entry.P}
                    `;
                    const m = createCircleMarker(entry.lat, entry.lon, entry.status, popup);
                    markersLayer.addLayer(m);
                }
            });

            if (points.length > 0) {
                const latLngs = points.map(p => [p.lat, p.lon]);
                map.fitBounds(latLngs, { padding: [30, 30] });
            }

            updateDensity();
        } catch (e) {
            console.error("Error loading entries", e);
        }
    }

    const legend = L.control({position: 'bottomright'});
    legend.onAdd = function () {
        const div = L.DomUtil.create('div', 'legend');
        div.innerHTML = `
            <b>Legend</b><br>
            <span style="background:green;"></span> Healthy<br>
            <span style="background:orange;"></span> Warning<br>
            <span style="background:red;"></span> Unhealthy
        `;
        return div;
    };
    legend.addTo(map);

    loadEntries();
</script>
</body>
</html>
