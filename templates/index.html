<script>
    function toggleShapeFields() {
        let shape = document.getElementById("shape").value;
        document.getElementById("rectangular_fields").style.display =
            (shape === "rectangular") ? "block" : "none";
        document.getElementById("circular_fields").style.display =
            (shape === "circular") ? "block" : "none";
    }

    let map;
    let markersLayer;
    let points = [];  // all points from backend

    // ----- PASSKEY -----
    function showPasskeyPrompt() {
        const key = prompt("Enter pass key to view OSS health data:");
        if (key === "1234") {
            document.getElementById("oss-section").style.display = "block";
            document.getElementById("oss-link").style.display = "none";

            setTimeout(function () {
                map.invalidateSize();
                loadEntries();  // show existing points once map is visible
            }, 200);
        } else if (key !== null) {
            alert("Incorrect pass key.");
        }
    }

    // ----- MAP INIT -----
    function initMap() {
        map = L.map('map').setView([20.5937, 78.9629], 5);

        L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
            maxZoom: 19,
            attribution: '&copy; OpenStreetMap &copy; CARTO'
        }).addTo(map);

        markersLayer = L.layerGroup().addTo(map);

        const legend = L.control({position: 'bottomright'});
        legend.onAdd = function () {
            const div = L.DomUtil.create('div', 'legend');
            div.innerHTML = `
                <b>Legend</b><br>
                <span style="background:green;"></span> Healthy<br>
                <span style="background:orange;"></span> Warning<br>
                <span style="background:red;"></span> Unhealthy
            `;
            return div;
        };
        legend.addTo(map);
    }

    function getColor(status) {
        if (status === "healthy") return "green";
        if (status === "warning") return "orange";
        return "red";
    }

    function createCircleMarker(lat, lon, status, popupText) {
        return L.circleMarker([lat, lon], {
            radius: 8,
            color: getColor(status),
            fillColor: getColor(status),
            fillOpacity: 0.8
        }).bindPopup(popupText);
    }

    // ----- DENSITY -----
    function updateDensity() {
        const n = points.length;
        const densityDiv = document.getElementById("density");

        if (n < 2) {
            densityDiv.textContent = "OSS density: need at least 2 points to estimate.";
            return;
        }

        let latMin = Infinity, latMax = -Infinity;
        let lonMin = Infinity, lonMax = -Infinity;

        points.forEach(p => {
            if (p.lat < latMin) latMin = p.lat;
            if (p.lat > latMax) latMax = p.lat;
            if (p.lon < lonMin) lonMin = p.lon;
            if (p.lon > lonMax) lonMax = p.lon;
        });

        const R = 6371000;
        const toRad = Math.PI / 180;

        const latCenter = (latMin + latMax) / 2 * toRad;
        const dLat = (latMax - latMin) * toRad;
        const dLon = (lonMax - lonMin) * toRad;

        const height = dLat * R;
        const width = dLon * R * Math.cos(latCenter);
        const area_m2 = Math.max(height * width, 1);

        const densityPerM2 = n / area_m2;
        const densityPerKm2 = densityPerM2 * 1e6;

        densityDiv.textContent =
            `Approx. OSS density: ${densityPerM2.toExponential(3)} points/m² (≈ ${densityPerKm2.toFixed(1)} points/km², based on bounding area)`;
    }

    // ----- LOAD ALL ENTRIES FROM BACKEND -----
    async function loadEntries() {
        try {
            let res = await fetch("/api/entries");
            let data = await res.json();

            markersLayer.clearLayers();
            points = [];

            data.forEach(entry => {
                if (entry.lat !== null && entry.lon !== null) {
                    points.push({ lat: entry.lat, lon: entry.lon });

                    let popup = `
                        Status: <b>${entry.status.toUpperCase()}</b><br>
                        Next emptying: ${entry.next_emptying_date}<br>
                        N (years): ${entry.N_years}<br>
                        P: ${entry.P}
                    `;
                    const m = createCircleMarker(entry.lat, entry.lon, entry.status, popup);
                    markersLayer.addLayer(m);
                }
            });

            // If there are points, zoom to their bounds
            if (points.length > 0) {
                const latLngs = points.map(p => [p.lat, p.lon]);
                map.fitBounds(latLngs);
            }

            updateDensity();
        } catch (e) {
            console.error("Error loading entries", e);
        }
    }

    // ----- MAIN CALCULATION -----
    async function calculate() {
        let shape = document.getElementById("shape").value;
        let payload = {
            last_date: document.getElementById("last_date").value,
            P: document.getElementById("P").value,
            q: document.getElementById("q").value,
            F: document.getElementById("F").value,
            S: document.getElementById("S").value,
            shape: shape,
            lat: document.getElementById("lat").value,
            lon: document.getElementById("lon").value
        };

        if (shape === "rectangular") {
            payload.length = document.getElementById("length").value;
            payload.width = document.getElementById("width").value;
            payload.depth = document.getElementById("depth").value;
        } else {
            payload.diameter = document.getElementById("diameter").value;
            payload.depth = document.getElementById("circular_depth").value;
        }

        let response = await fetch("/calculate", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload)
        });

        let result = await response.json();
        if (result.error) {
            document.getElementById("result").innerHTML =
                `<span style="color:red;">Error: ${result.error}</span>`;
            return;
        }

        document.getElementById("result").innerHTML = `
            Volume of pit: ${result.volume_litres} L<br>
            Target volume (2/3 full): ${result.target_volume} L<br>
            A (Liquid retention): ${result.A} L<br>
            B (Sludge & scum storage): ${result.B} L<br>
            Check (A + B): ${result.check_sum} L<br>
            N (years until 2/3 full): ${result.N_years} years<br>
            Next emptying date: ${result.next_emptying_date}<br>
            Health status: <b>${result.status.toUpperCase()}</b>
        `;

        // Refresh markers & density from backend data
        if (document.getElementById("oss-section").style.display !== "none") {
            loadEntries();
        }
    }

    // Init map as soon as page loads
    initMap();
</script>
