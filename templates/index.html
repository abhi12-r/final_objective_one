<script>
    function toggleShapeFields() {
        let shape = document.getElementById("shape").value;
        document.getElementById("rectangular_fields").style.display =
            (shape === "rectangular") ? "block" : "none";
        document.getElementById("circular_fields").style.display =
            (shape === "circular") ? "block" : "none";
    }

    // Initialize map (centered on India)
    let map = L.map('map').setView([20.5937, 78.9629], 5);

    // Basemap tiles (Carto + OSM)
    L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
        maxZoom: 19,
        attribution: '&copy; OpenStreetMap &copy; CARTO'
    }).addTo(map);

    // Layer group for markers (we will keep adding to this)
    let markersLayer = L.layerGroup().addTo(map);

    function getColor(status) {
        if (status === "healthy") return "green";
        if (status === "warning") return "orange";
        return "red";  // unhealthy or default
    }

    function createCircleMarker(lat, lon, status, popupText) {
        return L.circleMarker([lat, lon], {
            radius: 8,
            color: getColor(status),
            fillColor: getColor(status),
            fillOpacity: 0.8
        }).bindPopup(popupText);
    }

    async function calculate() {
        let shape = document.getElementById("shape").value;
        let payload = {
            last_date: document.getElementById("last_date").value,
            P: document.getElementById("P").value,
            q: document.getElementById("q").value,
            F: document.getElementById("F").value,
            S: document.getElementById("S").value,
            shape: shape,
            lat: document.getElementById("lat").value,
            lon: document.getElementById("lon").value
        };

        if (shape === "rectangular") {
            payload.length = document.getElementById("length").value;
            payload.width = document.getElementById("width").value;
            payload.depth = document.getElementById("depth").value;
        } else {
            payload.diameter = document.getElementById("diameter").value;
            payload.depth = document.getElementById("circular_depth").value;
        }

        let response = await fetch("/calculate", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload)
        });

        let result = await response.json();
        if (result.error) {
            document.getElementById("result").innerHTML =
                `<span style="color:red;">Error: ${result.error}</span>`;
            return;
        }

        // Show numeric results
        document.getElementById("result").innerHTML = `
            Volume of pit: ${result.volume_litres} L<br>
            Target volume (2/3 full): ${result.target_volume} L<br>
            A (Liquid retention): ${result.A} L<br>
            B (Sludge & scum storage): ${result.B} L<br>
            Check (A + B): ${result.check_sum} L<br>
            N (years until 2/3 full): ${result.N_years} years<br>
            Next emptying date: ${result.next_emptying_date}<br>
            Health status: <b>${result.status.toUpperCase()}</b>
        `;

        // ---- Add marker for this entry (without deleting old markers) ----
        const latStr = document.getElementById("lat").value;
        const lonStr = document.getElementById("lon").value;
        const lat = parseFloat(latStr);
        const lon = parseFloat(lonStr);

        if (!isNaN(lat) && !isNaN(lon)) {
            let popup = `
                Status: <b>${result.status.toUpperCase()}</b><br>
                Next emptying: ${result.next_emptying_date}<br>
                N (years): ${result.N_years}<br>
                P: ${payload.P}
            `;
            let marker = createCircleMarker(lat, lon, result.status, popup);
            markersLayer.addLayer(marker);

            // Zoom to the newly added point
            map.setView([lat, lon], 15);
        }
    }

    // Legend
    const legend = L.control({position: 'bottomright'});
    legend.onAdd = function () {
        const div = L.DomUtil.create('div', 'legend');
        div.innerHTML = `
            <b>Legend</b><br>
            <span style="background:green;"></span> Healthy<br>
            <span style="background:orange;"></span> Warning<br>
            <span style="background:red;"></span> Unhealthy
        `;
        return div;
    };
    legend.addTo(map);
</script>
